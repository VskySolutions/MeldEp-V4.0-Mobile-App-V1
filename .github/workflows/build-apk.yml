name: Android APK per Flavor (Append Builds)

on:
  push:
    branches: [dev, uat, prod]
  workflow_dispatch:
    inputs:
      flavor:
        description: "Flavor to build (overrides branch mapping)"
        type: choice
        required: false
        options: [dev, uat, prod]

env:
  VERSION_NAME: "1.1.0"  # Update this per release

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Resolve FLAVOR (branch or input)
        shell: bash
        run: |
          set -e
          if [[ -n "${{ github.event.inputs.flavor }}" ]]; then
            echo "FLAVOR=${{ github.event.inputs.flavor }}" >> $GITHUB_ENV
          else
            case "${GITHUB_REF_NAME}" in
              dev)  echo "FLAVOR=dev"  >> $GITHUB_ENV ;;
              uat) echo "FLAVOR=uat" >> $GITHUB_ENV ;;
              prod) echo "FLAVOR=prod" >> $GITHUB_ENV ;;
              *)    echo "FLAVOR=dev" >> $GITHUB_ENV ;;
            esac
          fi

      - name: Flutter pub get
        run: flutter pub get

      - name: Decode Android keystore (from secret)
        run: |
          mkdir -p android/app
          python - << 'PY'
          import os, base64, pathlib
          pathlib.Path("android/app").mkdir(parents=True, exist_ok=True)
          data = os.environ["ANDROID_KEYSTORE_BASE64"].strip()
          with open("android/app/keystore.jks", "wb") as f:
              f.write(base64.b64decode(data))
          PY
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create key.properties (module-relative path)
        run: |
          mkdir -p android
          cat > android/key.properties << 'EOF'
          storeFile=keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Set build numbers
        shell: bash
        run: |
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Build APK (release, flavored)
        run: |
          flutter build apk \
            --flavor "$FLAVOR" \
            --dart-define=FLAVOR="$FLAVOR" \
            --release \
            --build-name="$VERSION_NAME" \
            --build-number="$BUILD_NUMBER"

      - name: Write APK and notes (do not delete previous)
        shell: bash
        run: |
          set -e
          BUILD_DIR="builds/${FLAVOR}"
          mkdir -p "$BUILD_DIR"

          # Locate generated APK
          APK_SRC="build/app/outputs/flutter-apk/app-${FLAVOR}-release.apk"
          if [ ! -f "$APK_SRC" ]; then
            APK_SRC="build/app/outputs/apk/${FLAVOR}/release/app-${FLAVOR}-release.apk"
          fi

          # Base filename (no UTC; include build number for uniqueness)
          BASE="Meld-EP 4.0 V${VERSION_NAME}(${FLAVOR})"

          # Copy APK with requested name (keeps all previous builds)
          cp "$APK_SRC" "${BUILD_DIR}/${BASE}.apk"

          # Human-readable UTC timestamp
          TS_HUMAN=$(date -u +'%m-%d-%Y %H:%M:%S UTC')

          # Write matching .md with timestamp and editable bullets
          cat > "${BUILD_DIR}/${BASE}.md" <<EOF
          Build: ${BASE}.apk
          Date: ${TS_HUMAN}

          ## Major Highlights
          - Enabled automatic data refresh whenever a screen gains focus or the user navigates to it.
          - Added a pull-to-refresh message at the top of screens that support pull-to-refresh.
          - Integrated a reusable rich-text input component and implemented it across the app.
          - Added rich-text support in **My Task & Activity > Card > View > Activity Details**.
          - Calendar / Time Buddy: new Calendar screen, ICS URL input card, fetch & display ICS data in cards, month/year filters, and create timesheet directly from a meeting (preview subject → select Project > Module > Task > Activity → add timesheet line).
          - Added status dropdown in **My Task & Activity** card (change activity status); prevented adding timesheet entries for non-Open activities and prevented changing status to **Open** until activity details are added.
          - Replaced **Start/End Date** with **Created/Updated Date** in View Task Activity.

          ## UI / UX Improvements
          - Standardized naming conventions (is/has for booleans, …List for collections, clear handler names, load/build/update patterns) — code-style only, no behavior changes.
          - Aligned and grouped imports consistently (Flutter / third-party first, then project imports).
          - Reorganized file structure with consistent sections: Variable Declarations, Lifecycle, API Calls & Data Ops, Actions & Event Handlers, UI, UI Helpers, Model for improved readability.
          - Improved Apply Leave bottom card: made **Employee Name** header visible and prevented the **Save** button from blocking content.
          - Started work to show only necessary header options in Rich Text Field across screens.

          ## Bug Fixes & Quality
          - Fixed project → module filter linkage so selecting a Project updates its Module list correctly. (#9965)
          - Fixed reversed text input in Timesheet textbox. (#10015)
          - Fixed Timesheet dropdown showing limited values and improved dropdown filtering. (#10016)
          - Restored timesheet validation and required-field handling. (#10017)
          - Sorted Task dropdown values alphabetically. (#10018)
          - Fixed sequential loading and parent-child clearing for Timesheet / My Tasks & Activities filters. (#10019)
          - Fixed Leave Type dropdown not closing after selection. (#10026)
          - Fixed multiple UI/report issues: missing info icons, placeholder visibility, field colors, edit note bug, forgot-password link not clickable. (#9962, #9963, #9964, #9970, #9972, #9973, #9974)
          - Resolved invalid ICS key redirect handling. (#10067)
          - Fixed Android 13 navigation issues (manifest and dependency adjustments).

          EOF

      - name: Commit build artifacts
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add builds/
          git commit -m "Add ${FLAVOR} APK ${VERSION_NAME} (#${BUILD_NUMBER}) [skip ci]" || echo "No changes to commit"

      - name: Push artifacts with PAT
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.TOKEN }}
          branch: ${{ github.ref_name }}