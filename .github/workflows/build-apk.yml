name: Android APK per Flavor (Append Builds)

on:
  push:
    branches: [dev, uat, prod]
  workflow_dispatch:
    inputs:
      flavor:
        description: "Flavor to build (overrides branch mapping)"
        type: choice
        required: false
        options: [dev, uat, prod]

env:
  VERSION_NAME: "1.0.3"  # Update this per release

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Resolve FLAVOR (branch or input)
        shell: bash
        run: |
          set -e
          if [[ -n "${{ github.event.inputs.flavor }}" ]]; then
            echo "FLAVOR=${{ github.event.inputs.flavor }}" >> $GITHUB_ENV
          else
            case "${GITHUB_REF_NAME}" in
              dev)  echo "FLAVOR=dev"  >> $GITHUB_ENV ;;
              uat) echo "FLAVOR=uat" >> $GITHUB_ENV ;;
              prod) echo "FLAVOR=prod" >> $GITHUB_ENV ;;
              *)    echo "FLAVOR=dev" >> $GITHUB_ENV ;;
            esac
          fi

      - name: Flutter pub get
        run: flutter pub get

      - name: Decode Android keystore (from secret)
        run: |
          mkdir -p android/app
          python - << 'PY'
          import os, base64, pathlib
          pathlib.Path("android/app").mkdir(parents=True, exist_ok=True)
          data = os.environ["ANDROID_KEYSTORE_BASE64"].strip()
          with open("android/app/keystore.jks", "wb") as f:
              f.write(base64.b64decode(data))
          PY
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create key.properties (module-relative path)
        run: |
          mkdir -p android
          cat > android/key.properties << 'EOF'
          storeFile=keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Set build numbers
        shell: bash
        run: |
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Build APK (release, flavored)
        run: |
          flutter build apk \
            --flavor "$FLAVOR" \
            --dart-define=FLAVOR="$FLAVOR" \
            --release \
            --build-name="$VERSION_NAME" \
            --build-number="$BUILD_NUMBER"

      - name: Write APK and notes (do not delete previous)
        shell: bash
        run: |
          set -e
          BUILD_DIR="builds/${FLAVOR}"
          mkdir -p "$BUILD_DIR"

          # Locate generated APK
          APK_SRC="build/app/outputs/flutter-apk/app-${FLAVOR}-release.apk"
          if [ ! -f "$APK_SRC" ]; then
            APK_SRC="build/app/outputs/apk/${FLAVOR}/release/app-${FLAVOR}-release.apk"
          fi

          # Base filename (no UTC; include build number for uniqueness)
          BASE="Meld-EP 4.0 V${VERSION_NAME}(${FLAVOR})"

          # Copy APK with requested name (keeps all previous builds)
          cp "$APK_SRC" "${BUILD_DIR}/${BASE}.apk"

          # Human-readable UTC timestamp
          TS_HUMAN=$(date -u +'%m-%d-%Y %H:%M:%S UTC')

          # Write matching .md with timestamp and editable bullets
          cat > "${BUILD_DIR}/${BASE}.md" <<EOF
          Build: ${BASE}.apk
          Date: ${TS_HUMAN}

          - Added instructions on "how to get your Microsoft ICS URL" in the “Add ICS URL” card.
          - Displaying timesheet line details if they are already filled.
          - Added functionality to delete timesheet lines.
          - Researched on how we can achieve ICS key validation in the mobile application.
          - Replaced Start/End Date with Created/Updated Date in the View Task Activity.
          - Improving the Apply Leave bottom card UI by making the Employee Name header visible and fixing the issue where the Save button blocked content horizontally.
          - Added a status dropdown in the My Task and Activity screen card so users can change the activity status.
          - Restricted users from adding timesheet entries for activities that are not Open.
          - Restricted users from changing an activity status to Open until activity details are added.
          - Started working on Rich Text Field to display only the necessary header options for different screens.
          - For different screens/ forms showed only required options as on web app.
          - It was hard to manage default options of rich text input field, created custom options with icons to match options with web app.
          - Added API call to get activity status options and display them in dropdown option.
          - Added dropdown on My Task and Activity edit screen so users can change the activity status 
          - Added API call function to change activity status. 
          - #10067- Invalid ICS Key Still Redirects
          - #19965 - Modules not updated when project changes-Mobile app
          - #10015 - Text typed in reverse in Timesheet text box
          - #10016 - Timesheet Dropdown Shows Limited Values
          - #10017 - Timesheet Validation Missing
          - #10018 - Task Dropdown Sequence Issue
          - #10019 - Timesheet and My Tasks & Activities Filter Loading Issue
          - #10026 - Leave Type Dropdown Not Closing

          EOF

      - name: Commit build artifacts
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add builds/
          git commit -m "Add ${FLAVOR} APK ${VERSION_NAME} (#${BUILD_NUMBER}) [skip ci]" || echo "No changes to commit"

      - name: Push artifacts with PAT
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.TOKEN }}
          branch: ${{ github.ref_name }}